####
# This is the share configuration of jobs for lassen
.on_lassen:
  variables:
  tags:
    - shell
    - lassen
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /_lnone/ || $ON_LASSEN == "OFF"' #run except if ...
      when: never
    - when: on_success

####
# Load required CUDA module
.with_cuda:
  before_script:
    - module load cuda/11.1.1

####
# Template
.build_on_lassen:
  stage: l_build
  extends: [.build_blueos_3_ppc64le_ib_p9_script, .on_lassen]
  needs: []

####
# Build jobs
clang_upstream_link_with_nvcc (lassen):
  variables:
    BUILD_DIR: "build_clang_upstream_link_with_nvcc"
    HOST_CONFIG: "clang@upstream_link_with_nvcc.cmake"
  extends: [.build_on_lassen, .with_cuda]

clang_upstream_nvcc_c++17 (lassen):
  variables:
    BUILD_DIR: "build_clang_upstream_nvcc_c++17"
    HOST_CONFIG: "clang@upstream_nvcc_c++17.cmake"
  extends: [.build_on_lassen, .with_cuda]

clang_upstream_nvcc_c++17_no_separable (lassen):
  variables:
    BUILD_DIR: "build_clang_upstream_nvcc_c++17_no_separable"
    HOST_CONFIG: "clang@upstream_nvcc_c++17_no_separable.cmake"
  extends: [.build_on_lassen, .with_cuda]

clang_upstream_nvcc_xlf (lassen):
  variables:
    BUILD_DIR: "build_clang_upstream_nvcc_xlf"
    HOST_CONFIG: "clang@upstream_nvcc_xlf.cmake"
  extends: [.build_on_lassen, .with_cuda]

pgi_20.4_nvcc (lassen):
  variables:
    BUILD_DIR: "build_clang_upstream_link_with_nvcc"
    HOST_CONFIG: "pgi@20.4_nvcc.cmake"
  extends: [.build_on_lassen, .with_cuda]
